


<!DOCTYPE html>
<html lang="zh-CN">
<head>
    
    <meta name="author" content="Sally">
    
    <meta name="description" content="Android 网络通信框架 Volley几个特点
支持 get post 网络图片 等的高效异步处理请求

可以对请求进行排序

支持网络请求缓存

支持多级别取消请求

与activity生命周期联动

不适合数据的上传和下载（如果需要上传和下载，选用别的，eg：okhttp）


功能
高效的">
    
    

    
    
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>android - volley的使用 | senbaisang · cooooooooder</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="/css/style.css" type="text/css">

    

    <!-- Javascript -->
    <script src="/js/jquery-2.1.0.min.js"></script>
    <script src="/js/jquery.backstretch.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <script src="/js/headroom.min.js"></script>
    <script src="/js/jquery.headroom.min.js"></script>
    <script src="/js/common.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="banner">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://senbaisang.github.io" title="senbaisang">senbaisang</a>
            </div>

            <div role="navigation" class="collapse navbar-collapse bs-navbar-collapse">
                <p class="navbar-text pull-right">cooooooooder</p>

                <ul class="nav navbar-nav">
                    
                    <li id="nav-index"><a href="/">首页</a></li>
                    
                    <li id="nav-archives"><a href="/archives">归档</a></li>
                    
                    <li id="nav-tags"><a href="/tags">标签</a></li>
                    
                    <li id="nav-categories"><a href="/categories">分类</a></li>
                    

                    <li><a href="https://github.com/senbaisang" target="_blank">GitHub</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <script>
    var backRoot = "/images/background/";
    var backArray = [ "1.jpg", "2.jpg", "3.jpg", "4.jpg", "5.jpg", "6.jpg", "8.jpg",  ];

    $(function() {
        // page-id...
        var pageId = "2016/01/12/android-volley的使用/";
        pageId = pageId.substr(0, pageId.indexOf("/"));
        if(pageId === "") pageId = "index";

        $("#nav-" + pageId).addClass("active");
    });
    </script>


  <article class="post container">
    <div class="well post-body first-post last-post">
        <h1>android - volley的使用</h1>

        <div class="time-info">
发表于:<time datetime="2016-01-12T02:59:24.000Z" itemprop="datePublished">2016-01-12</time>，更新于:<time datetime="2017-08-26T14:04:16.000Z" itemprop="dateModified">2017-08-26</time>，By <a href="http://senbaisang.github.io" title="Sally">Sally</a>
        </div>

        <div class="post-body-inner">
            <div id="toc" class="toc-article well">
                <strong class="toc-title">大纲</strong>
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Android_网络通信框架_Volley"><span class="toc-number">1.</span> <span class="toc-text">Android 网络通信框架 Volley</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#几个特点"><span class="toc-number">1.1.</span> <span class="toc-text">几个特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#功能"><span class="toc-number">1.2.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#请求包括以下几种对象"><span class="toc-number">1.3.</span> <span class="toc-text">请求包括以下几种对象</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#volley_的使用"><span class="toc-number">2.</span> <span class="toc-text">volley 的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#先声明请求队列_RequestQueue"><span class="toc-number">2.1.</span> <span class="toc-text">先声明请求队列 RequestQueue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#字符数据处理_:_StringRequest"><span class="toc-number">2.2.</span> <span class="toc-text">字符数据处理 : StringRequest</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#get_方式"><span class="toc-number">2.2.1.</span> <span class="toc-text">get 方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#post_方式"><span class="toc-number">2.2.2.</span> <span class="toc-text">post 方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JSON对象数据处理_:_JsonObject"><span class="toc-number">2.3.</span> <span class="toc-text">JSON对象数据处理 : JsonObject</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#get_方法"><span class="toc-number">2.3.1.</span> <span class="toc-text">get 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#post_方法"><span class="toc-number">2.3.2.</span> <span class="toc-text">post 方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#volley_和_activity_的关联"><span class="toc-number">2.4.</span> <span class="toc-text">volley 和 activity 的关联</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#自定义_volley"><span class="toc-number">3.</span> <span class="toc-text">自定义 volley</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#首先：定义_VolleyInterface_抽象类"><span class="toc-number">3.1.</span> <span class="toc-text">首先：定义 VolleyInterface 抽象类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#接着：定义请求工具类，这里以StringRequest为例"><span class="toc-number">3.2.</span> <span class="toc-text">接着：定义请求工具类，这里以StringRequest为例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最后：使用自定义volley实现get请求_:_stringrequest"><span class="toc-number">3.3.</span> <span class="toc-text">最后：使用自定义volley实现get请求 : stringrequest</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#图片缓存"><span class="toc-number">4.</span> <span class="toc-text">图片缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ImageRequest_的使用"><span class="toc-number">4.1.</span> <span class="toc-text">ImageRequest 的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ImageLoader_+_ImageCache_+_LruCache_：缓存图片"><span class="toc-number">4.2.</span> <span class="toc-text">ImageLoader + ImageCache + LruCache ：缓存图片</span></a></li></ol></li></ol>
            </div>

            <h1 id="Android_网络通信框架_Volley">Android 网络通信框架 Volley</h1><h2 id="几个特点">几个特点</h2><ul>
<li><p>支持 <code>get</code> <code>post</code> <code>网络图片</code> 等的高效异步处理请求</p>
</li>
<li><p>可以对请求进行排序</p>
</li>
<li><p>支持网络请求缓存</p>
</li>
<li><p>支持多级别取消请求</p>
</li>
<li><p>与activity生命周期联动</p>
</li>
<li><p>不适合数据的上传和下载（如果需要上传和下载，选用别的，eg：okhttp）</p>
</li>
</ul>
<h2 id="功能">功能</h2><ul>
<li><p>高效的get post方式的数据请求交互</p>
</li>
<li><p>网络图片的加载和缓存</p>
</li>
</ul>
<h2 id="请求包括以下几种对象">请求包括以下几种对象</h2><ul>
<li><p>StringRequest : 不清楚数据的返回类型时，使用stringrequest</p>
</li>
<li><p>JsonObjectRequest : 返回的是json对象时，使用jsonobjectrequest</p>
</li>
<li><p>JsonArrayRequest : 返回的是json数组时，使用jsonarrayrequest</p>
</li>
</ul>
<h1 id="volley_的使用">volley 的使用</h1><h2 id="先声明请求队列_RequestQueue">先声明请求队列 RequestQueue</h2><ul>
<li>所有request 请求都是放到这个队列进行处理，所以我们将这个队列声明在Application里，记得在manifest中配置一下myapplication</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> RequestQueue queues = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>.onCreate();</span><br><span class="line">      queues = Volley.newRequestQueue(getApplicationContext());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestQueue <span class="title">getHttpRequestQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> queues;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="字符数据处理_:_StringRequest">字符数据处理 : StringRequest</h2><h3 id="get_方式">get 方式</h3><ul>
<li>这里使用了4个参数的方法：请求方式，请求地址，请求成功回调，请求失败回调</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">volley_get_string</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String url = <span class="string">"http://172.21.170.2:3333/interface/communicate_log/friends?mobilephone=supervisor_17777777777"</span>;</span><br><span class="line">  StringRequest request = <span class="keyword">new</span> StringRequest(Method.GET, url, <span class="keyword">new</span> Listener&lt;String&gt;() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(String response)</span> </span>&#123;</span><br><span class="line">      Toast.makeText(MainActivity.<span class="keyword">this</span>, response, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="keyword">new</span> ErrorListener() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</span><br><span class="line">      Toast.makeText(MainActivity.<span class="keyword">this</span>, error.toString(), Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置tag标签，关闭任务时，会用到</span></span><br><span class="line">  request.setTag(<span class="string">"StringRequestGett"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将该请求添加到请求队列中</span></span><br><span class="line">  MyApplication.getHttpRequestQueue().add(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="post_方式">post 方式</h3><ul>
<li>参数：请求方式，请求地址，请求成功回调，请求失败回调，重写getParams()方法获得请求参数。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">volley_post_string</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String url = <span class="string">"http://172.21.170.2:3333/interface/communicate_log/friends?"</span>;</span><br><span class="line">  StringRequest request = <span class="keyword">new</span> StringRequest(Method.POST, url, <span class="keyword">new</span> Listener&lt;String&gt;() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(String response)</span> </span>&#123;</span><br><span class="line">      Toast.makeText(MainActivity.<span class="keyword">this</span>, response, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="keyword">new</span> ErrorListener() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</span><br><span class="line">      Toast.makeText(MainActivity.<span class="keyword">this</span>, error.toString(), Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Map&lt;String, String&gt; getParams() <span class="keyword">throws</span> AuthFailureError &#123;</span><br><span class="line">      <span class="comment">// 将参数放到map集合中，并返回，post请求会自己调用</span></span><br><span class="line">      Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">      map.put(<span class="string">"mobilephone"</span>, <span class="string">"supervisor_17777777777"</span>);</span><br><span class="line">      <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置标签</span></span><br><span class="line">  request.setTag(<span class="string">"StringRequestPost"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加到请求队列中</span></span><br><span class="line">  MyApplication.getHttpRequestQueue().add(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="JSON对象数据处理_:_JsonObject">JSON对象数据处理 : JsonObject</h2><h3 id="get_方法">get 方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">volley_get_jsonobject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String url = <span class="string">"http://172.21.170.2:3333/interface/communicate_log/friends?mobilephone=supervisor_17777777777"</span>;</span><br><span class="line">  JsonObjectRequest request = <span class="keyword">new</span> JsonObjectRequest(Method.GET, url, <span class="keyword">new</span> Listener&lt;JSONObject&gt;() &#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(JSONObject response)</span> </span>&#123;</span><br><span class="line">      Toast.makeText(MainActivity.<span class="keyword">this</span>, response.toString(), Toast.LENGTH_SHORT).show();</span><br><span class="line">      &#125;</span><br><span class="line">      &#125;, <span class="keyword">new</span> ErrorListener() &#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</span><br><span class="line">      Toast.makeText(MainActivity.<span class="keyword">this</span>, error.toString(), Toast.LENGTH_SHORT).show();</span><br><span class="line">      &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  request.setTag(<span class="string">"JsonObjectGet"</span>);</span><br><span class="line">  MyApplication.getHttpRequestQueue().add(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="post_方法">post 方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">volley_psot_jsonobject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String url = <span class="string">"http://172.21.170.2:3333/interface/communicate_log/friends?"</span>;</span><br><span class="line">  Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">  map.put(<span class="string">"mobilephone"</span>, <span class="string">"supervisor_17777777777"</span>);</span><br><span class="line">  JSONObject obj = <span class="keyword">new</span> JSONObject(map);</span><br><span class="line">  JsonObjectRequest request = <span class="keyword">new</span> JsonObjectRequest(Method.POST, url, obj, <span class="keyword">new</span> Listener&lt;JSONObject&gt;() &#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(JSONObject response)</span> </span>&#123;</span><br><span class="line">      Toast.makeText(MainActivity.<span class="keyword">this</span>, response.toString(), Toast.LENGTH_SHORT).show();</span><br><span class="line">      &#125;</span><br><span class="line">      &#125;, <span class="keyword">new</span> ErrorListener() &#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</span><br><span class="line">      Toast.makeText(MainActivity.<span class="keyword">this</span>, error.toString(), Toast.LENGTH_SHORT).show();</span><br><span class="line">      &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  request.setTag(<span class="string">"JsonObjectPost"</span>);</span><br><span class="line">  MyApplication.getHttpRequestQueue().add(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="volley_和_activity_的关联">volley 和 activity 的关联</h2><ul>
<li>在销毁activity时，取消掉该activity的所有请求</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>.onDestroy();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这里，就是根据上面设置的tag进行取消的，所以tag值要有意义</span></span><br><span class="line">  MyApplication.getHttpRequestQueue().cancelAll(<span class="string">"Get"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="自定义_volley">自定义 volley</h1><ul>
<li>有时候，我们需要在请求成功时，做些事情；在请求失败时，做些事情；请求多了，每次都写会重复很多。所以就需要自定义volley了</li>
</ul>
<h2 id="首先：定义_VolleyInterface_抽象类">首先：定义 VolleyInterface 抽象类</h2><ul>
<li><p>声明一个有3个参数的构造方法，上下文，成功监听回调，失败监听回调</p>
</li>
<li><p>两个抽象方法： 请求成功方法， 请求失败方法</p>
</li>
<li><p>在这里，可以做一些处理，请求成功了做什么，请求失败了做什么</p>
</li>
<li><p>注意：这里的mListener mErrorListener都是静态的，且这两个对象都是在这个文件中创建和使用，自给自足</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">VolleyInterface</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Context mContext;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> Listener&lt;String&gt; mListener;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> ErrorListener mErrorListener;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">VolleyInterface</span><span class="params">(Context context, Listener listener, ErrorListener errorListener)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.mContext = context;</span><br><span class="line">    <span class="keyword">this</span>.mListener = listener;</span><br><span class="line">    <span class="keyword">this</span>.mErrorListener = errorListener;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Listener&lt;String&gt; <span class="title">loadListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mListener = <span class="keyword">new</span> Listener&lt;String&gt;() &#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(String response)</span> </span>&#123;</span><br><span class="line">          onMyLoading(response);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 请求成功做些什么事</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> mListener;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ErrorListener <span class="title">errorListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mErrorListener = <span class="keyword">new</span> ErrorListener() &#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</span><br><span class="line">          onMyError(error);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 请求失败做些什么事</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> mErrorListener;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onMyLoading</span><span class="params">(String result)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onMyError</span><span class="params">(VolleyError error)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="接着：定义请求工具类，这里以StringRequest为例">接着：定义请求工具类，这里以StringRequest为例</h2><ul>
<li><p>get方式的参数：上下文，请求地址，tag标签，回调接口</p>
</li>
<li><p>post方式的参数：上下文，请求url，tag标签，请求参数params，回调接口</p>
</li>
<li><p>这里记得start一下请求队列</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolleyRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> StringRequest stringRequest;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> Context mContext;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RequestGet</span><span class="params">(Context context, String url, String tag, VolleyInterface vif)</span> </span>&#123;</span><br><span class="line">    MyApplication.getHttpRequestQueue().cancelAll(tag);</span><br><span class="line"></span><br><span class="line">    stringRequest = <span class="keyword">new</span> StringRequest(Request.Method.GET, url, vif.loadListener(), vif.errorListener());</span><br><span class="line">    stringRequest.setTag(<span class="string">"get"</span>);</span><br><span class="line"></span><br><span class="line">    MyApplication.getHttpRequestQueue().add(stringRequest);</span><br><span class="line">    MyApplication.getHttpRequestQueue().start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ResuestPost</span><span class="params">(Context context, String url, String tag, <span class="keyword">final</span> Map&lt;String, String&gt; params, VolleyInterface vif)</span> </span>&#123;</span><br><span class="line">    MyApplication.getHttpRequestQueue().cancelAll(tag);</span><br><span class="line"></span><br><span class="line">    StringRequest request = <span class="keyword">new</span> StringRequest(Method.POST, url, vif.loadListener(), vif.errorListener())&#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Map&lt;String, String&gt; getParams() <span class="keyword">throws</span> AuthFailureError &#123;</span><br><span class="line">          <span class="keyword">return</span> params;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    request.setTag(<span class="string">"post"</span>);</span><br><span class="line">    MyApplication.getHttpRequestQueue().add(request);</span><br><span class="line">    MyApplication.getHttpRequestQueue().start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="最后：使用自定义volley实现get请求_:_stringrequest">最后：使用自定义volley实现get请求 : stringrequest</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">volley_get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String url = <span class="string">"http://172.21.170.2:3333/interface/communicate_log/friends?mobilephone=supervisor_17777777777"</span>;</span><br><span class="line">  VolleyRequest.RequestGet(<span class="keyword">this</span>, url, <span class="string">"abcget"</span>, <span class="keyword">new</span> VolleyInterface(<span class="keyword">this</span>, VolleyInterface.mListener, VolleyInterface.mErrorListener) &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMyLoading</span><span class="params">(String result)</span> </span>&#123;</span><br><span class="line">      Toast.makeText(MainActivity.<span class="keyword">this</span>, result, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMyError</span><span class="params">(VolleyError error)</span> </span>&#123;</span><br><span class="line">      Toast.makeText(MainActivity.<span class="keyword">this</span>, error.toString(), Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="图片缓存">图片缓存</h1><ul>
<li><p>ImageRequest : 加载远程图片</p>
</li>
<li><p><code>ImageCache</code> 单独使用起不到缓存作用，要搭配 <code>LruCache</code> 一起使用</p>
</li>
<li><p>ImageCache + ImageView : 图片缓存</p>
</li>
<li><p>ImageCache + NetWorkImageView : 图片缓存</p>
</li>
</ul>
<h2 id="ImageRequest_的使用">ImageRequest 的使用</h2><ul>
<li>加载远程图片</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">volley_img_request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String url = <span class="string">"https://www.baidu.com/img/bdlogo.png"</span>;</span><br><span class="line">  ImageRequest request = <span class="keyword">new</span> ImageRequest(url, <span class="keyword">new</span> Listener&lt;Bitmap&gt;() &#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Bitmap response)</span> </span>&#123;</span><br><span class="line">        iv.setImageBitmap(response);</span><br><span class="line">      &#125;</span><br><span class="line">      &#125;, <span class="number">0</span>, <span class="number">0</span>, ImageView.ScaleType.CENTER, Bitmap.Config.RGB_565, <span class="keyword">new</span> ErrorListener() &#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(MainActivity2.<span class="keyword">this</span>, error.toString(), Toast.LENGTH_SHORT).show();</span><br><span class="line">      &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">  request.setTag(<span class="string">"imgRequest"</span>);</span><br><span class="line">  MyApplication.getHttpRequestQueue().add(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ImageLoader_+_ImageCache_+_LruCache_：缓存图片">ImageLoader + ImageCache + LruCache ：缓存图片</h2><ul>
<li><p>这里需要用到 ImageLoader 类，该对象接受两个参数：请求队列，imagecache</p>
</li>
<li><p>首先：定义一个ImageCache的子类，BitmapCache</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BitmapCache</span> <span class="keyword">implements</span> <span class="title">ImageCache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> LruCache&lt;String, Bitmap&gt; cache;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//默认缓存大小10m</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> max = <span class="number">10</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">BitmapCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cache = <span class="keyword">new</span> LruCache&lt;String, Bitmap&gt;(max)&#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">sizeOf</span><span class="params">(String key, Bitmap value)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> value.getRowBytes() * value.getHeight();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回缓存中的图片</span></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Bitmap <span class="title">getBitmap</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> cache.get(url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将图片放入缓存</span></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putBitmap</span><span class="params">(String url, Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">      cache.put(url, bitmap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>接着：获取并显示图片，使用 <code>imageview</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">volley_img_loader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String url = <span class="string">"https://www.baidu.com/img/bdlogo.png"</span>;</span><br><span class="line">  ImageLoader loader = <span class="keyword">new</span> ImageLoader(MyApplication.getHttpRequestQueue(), <span class="keyword">new</span> BitmapCache());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 参数： 显示图片的控件，默认图片，请求失败显示图片</span></span><br><span class="line">  ImageListener listener = ImageLoader.getImageListener(iv, R.mipmap.ic_launcher, R.mipmap.ic_launcher);</span><br><span class="line">  loader.get(url, listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>接着：获取并显示图片，使用 <code>networkimageView</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">volley_img_network</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String url = <span class="string">"https://www.baidu.com/img/bdlogo.png"</span>;</span><br><span class="line">  ImageLoader loader = <span class="keyword">new</span> ImageLoader(MyApplication.getHttpRequestQueue(), <span class="keyword">new</span> BitmapCache());</span><br><span class="line">  iv_net.setDefaultImageResId(R.mipmap.ic_launcher);</span><br><span class="line">  iv_net.setErrorImageResId(R.mipmap.ic_launcher);</span><br><span class="line">  iv_net.setImageUrl(url, loader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


			
            <section class="comment">
<!-- 多说评论框 start -->
<!-- 多说公共JS代码 end -->
</section>




        </div>
    </div>
</article>


    <footer id="footer">
    <div id="bottom-tip">
        senbaisang —— <small>cooooooooder</small>
    </div>
        <small>该博客由 <a href="https://hexo.io/" target="_blank">Hexo</a> 强力驱动，搭载 <a href="https://github.com/XadillaX/hexadillax" target="_blank">Hexadillax</a> 主题</small><br />
        <small>&copy; 2015 Sally</small>
    </footer>

    


</body>
</html>


